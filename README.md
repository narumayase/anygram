# anygram API

anygram is an API built with FastAPI that allows sending and receiving messages through a Telegram bot, integrating automatic responses generated by an LLM (Large Language Model).

The API exposes two main endpoints:

- **`/telegram/send`**: Allows sending messages to any Telegram chat through the bot.
- **`/telegram/webhook`**: Receives messages sent to the bot from Telegram, forwards the received text to an LLM API, and automatically replies to the user with the generated response.

## Project Structure

```
anygram
├── app
│   ├── api.py              # Endpoints 
│   ├── models.py           # Pydantic models or simple entities
│   ├── services.py         # Integrations (Telegram, LLM)
│   ├── config.py           # Configuration (dotenv, etc.)
│   └── main.py             # Entry point
├── requirements.txt
└── README.md
```

## Setup

1. Create a virtual environment:
   ```
   python -m venv venv
   source venv/bin/activate  # On Windows use `venv\Scripts\activate`
   ```

2. Install dependencies:
   ```
   pip install -r requirements.txt
   ```

3. Create a `.env` file:
   ```
   # Telegram configuration (required)
   TELEGRAM_TOKEN=your_api_token
   TELEGRAM_API_URL="https://api.telegram.org"

   # LLM configuration (required)   
   LLM_URL=http://localhost:8081/api/v1/chat/ask

   # server configuration (optional)
   HOST=127.0.0.1
   PORT=8000
   RELOAD=true
   LOG_LEVEL=INFO

   # Kafka configuration (optional)
   KAFKA_ENABLED=false
   KAFKA_BROKER=localhost:9092
   KAFKA_TOPIC=input-messages
   ```

## Environment Variables

- `TELEGRAM_TOKEN`: Telegram bot token (required).
- `TELEGRAM_API_URL`: Telegram API URL (optional, defaults to `https://api.telegram.org`).
- `LLM_URL`: LLM API URL (optional, defaults to `http://localhost:8081/api/v1/chat/ask`).
- `HOST`: API host (optional, defaults to `127.0.0.1`).
- `PORT`: API port (optional, defaults to `8000`).
- `RELOAD`: Enable auto-reloading of the server (optional, defaults to `true`).
- `LOG_LEVEL`: Logging level (optional, defaults to `INFO`).
- `KAFKA_ENABLED`: Enable Kafka integration (optional, defaults to `false`).
- `KAFKA_BROKER`: Kafka broker address (optional, defaults to `localhost:9092`).
- `KAFKA_TOPIC`: Kafka topic for prompts (optional, defaults to `anygram.prompts`).

## Usage

To run the application:
```
uvicorn app.main:app --host $HOST --port $PORT
```

By default, the API will be available at `http://127.0.0.1:8000`.

## Kafka Integration

This API supports integration with Kafka for asynchronous message processing. When Kafka is enabled, incoming messages from Telegram webhooks will be sent to a Kafka topic instead of being processed directly by the LLM.

To enable Kafka integration, set the `KAFKA_ENABLED` environment variable to `true` in your `.env` file:

```
KAFKA_ENABLED=true
KAFKA_BROKER=localhost:9092  # Your Kafka broker address
KAFKA_TOPIC=anygram.prompts  # The topic to send messages to
```

When `KAFKA_ENABLED` is `true`:
- The `/telegram/webhook` endpoint will send the incoming message to the configured Kafka topic.
- The API will respond immediately with `{"ok": True, "source": "kafka"}`.
- The actual LLM processing and Telegram response will be handled by a separate consumer service that reads from the Kafka topic.

If `KAFKA_ENABLED` is `false` (default), the API will process messages synchronously using the LLM and respond directly via Telegram, as described in the "Webhook" section.

## Endpoints

### GET /health

Checks the API status.

```json
{
   "message": "anygram API is working!",
   "status": "ok",
   "host": "localhost",
   "port": "8000"
}
```

### Send a Message

POST to `/telegram/send` sends a message through the Telegram bot using the following body:

```json
{
  "chat_id": "123456789",
  "text": "Your message here"
}
```

### Webhook (Receive and Reply to Messages)

The `/telegram/webhook` endpoint receives messages from Telegram and automatically replies using the integration with the LLM API.

**Webhook Example Configuration:**

1. Expose the local API using [ngrok](https://ngrok.com/):
   ```
   ngrok http 8000
   ```

2. Set the webhook in Telegram:
   ```
   curl -X POST "https://api.telegram.org/bot<TELEGRAM_TOKEN>/setWebhook?url=https://<NGROK_URL>/telegram/webhook"
   ```
   Replace `<TELEGRAM_TOKEN>` and `<NGROK_URL>` with the correct values.

# Testing

- All tests:

```bash
pytest
```

- All test with coverage:

```bash
pytest --cov=app --cov-report=term-missing tests/
```

## BackLog

- [x] Unit Tests.
- [ ] Add integration with kafka (producer).
